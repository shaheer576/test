#!/usr/bin/env python3
"""
Diagnostic tool for CMM Extraction
Helps troubleshoot configuration and access issues
"""

import os
import sys
import configparser
from pathlib import Path

def diagnose():
    """Run diagnostics on CMM Extraction Tool setup"""
    
    print("="*70)
    print("CMM EXTRACTION TOOL - DIAGNOSTIC CHECK")
    print("="*70)
    
    # Check Python version
    print("\n1. PYTHON VERSION:")
    print(f"   {sys.version}")
    if sys.version_info < (3, 8):
        print("   ⚠ WARNING: Python 3.8 or higher recommended")
    else:
        print("   ✓ OK")
    
    # Check if config.ini exists
    print("\n2. CONFIGURATION FILE:")
    if os.path.exists('config.ini'):
        print("   ✓ config.ini found")
    else:
        print("   ✗ config.ini NOT FOUND")
        print("   → Create config.ini before running the tool")
        return
    
    # Load config
    config = configparser.ConfigParser()
    config.read('config.ini')
    
    # Check shared drives
    print("\n3. SHARED DRIVES:")
    if not config.has_section('SharedDrives'):
        print("   ✗ No [SharedDrives] section in config.ini")
        print("   → Add [SharedDrives] section with drive paths")
        return
    
    drives = []
    for key, value in config.items('SharedDrives'):
        if value and key != 'DEFAULT':
            drives.append(value)
    
    if not drives:
        print("   ✗ No drives configured")
        print("   → Add drive paths under [SharedDrives] in config.ini")
        return
    
    print(f"   Found {len(drives)} configured drive(s):")
    accessible_count = 0
    for idx, drive in enumerate(drives):
        print(f"\n   [{idx+1}] {drive}")
        
        # Check if accessible
        if os.path.exists(drive) and os.path.isdir(drive):
            print(f"       ✓ Accessible")
            accessible_count += 1
            
            # List some contents
            try:
                contents = os.listdir(drive)
                print(f"       → Contains {len(contents)} items")
                
                # Show first few directories
                dirs = [d for d in contents if os.path.isdir(os.path.join(drive, d))]
                if dirs:
                    print(f"       → First few directories:")
                    for d in dirs[:5]:
                        print(f"          {d}/")
                
            except Exception as e:
                print(f"       ⚠ Could not list contents: {e}")
        else:
            print(f"       ✗ NOT accessible")
            print(f"       → Check network connection and permissions")
    
    if accessible_count == 0:
        print(f"\n   ⚠ WARNING: No drives accessible!")
        print(f"   → Check network connections")
        print(f"   → Verify drive paths in config.ini")
    else:
        print(f"\n   ✓ {accessible_count} of {len(drives)} drive(s) accessible")
    
    # Check Python packages
    print("\n4. REQUIRED PACKAGES:")
    required_packages = [
        'openpyxl',
        'pdfplumber',
        'pandas',
        'numpy'
    ]
    
    missing_packages = []
    for package in required_packages:
        try:
            __import__(package)
            print(f"   ✓ {package}")
        except ImportError:
            print(f"   ✗ {package} NOT INSTALLED")
            missing_packages.append(package)
    
    if missing_packages:
        print(f"\n   ⚠ Missing packages: {', '.join(missing_packages)}")
        print(f"   → Run: pip install -r requirements.txt")
    
    # Check temp directory
    print("\n5. TEMP DIRECTORY:")
    temp_dir = config.get('Paths', 'temp_directory', fallback='C:/Temp/Temp_CMM_Files')
    print(f"   Configured: {temp_dir}")
    
    if os.path.exists(temp_dir):
        print(f"   ✓ Exists")
    else:
        print(f"   ⚠ Does not exist (will be created)")
    
    # Try to write to temp
    try:
        test_file = os.path.join(temp_dir if os.path.exists(temp_dir) else '.', 'test_write.txt')
        os.makedirs(os.path.dirname(test_file), exist_ok=True)
        with open(test_file, 'w') as f:
            f.write('test')
        os.remove(test_file)
        print(f"   ✓ Writable")
    except Exception as e:
        print(f"   ✗ Cannot write: {e}")
    
    # Summary
    print("\n" + "="*70)
    print("DIAGNOSTIC SUMMARY")
    print("="*70)
    
    if accessible_count > 0 and not missing_packages:
        print("✓ System appears ready to use")
        print("\nNext steps:")
        print("  1. Verify part numbers exist in the accessible drives")
        print("  2. Run with a test part number:")
        print("     python cmm_extraction.py --part YOUR_PART --start 2024-01-01 --end 2024-12-31")
    else:
        print("⚠ Issues detected - please resolve before running:")
        if accessible_count == 0:
            print("  → Fix shared drive access")
        if missing_packages:
            print("  → Install missing packages")
    
    print("\n" + "="*70)

if __name__ == '__main__':
    try:
        diagnose()
    except Exception as e:
        print(f"\n✗ Diagnostic failed with error: {e}")
        import traceback
        traceback.print_exc()

